<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Cross-Device Screen Sharing</title>
  <style>
    body { font-family: system-ui, Arial; max-width:900px; margin:32px auto; }
    h1 { margin-bottom: 6px; }
    .row { display:flex; gap:12px; margin:12px 0; flex-wrap:wrap; }
    button { padding:8px 12px; }
    input { padding:8px; min-width:220px; }
    video { width:100%; max-height: 50vh; background:#000; border-radius:6px; }
    .small { font-size: 0.9rem; color:#555; }
    .info { margin-top:18px; padding:12px; border-radius:8px; background:#f6f6f6; color:#333; }
    label { display:block; margin-bottom:6px; font-weight:600;}
  </style>
</head>
<body>
  <h1>Screen / Camera Sharing (PC + Mobile)</h1>
  <p class="small">Host can share either screen (if supported) or camera. Viewer joins using Room ID.</p>

  <div class="row">
    <div>
      <label>Host / Share</label>
      <button id="screenShareBtn">Share Screen</button>
      <button id="cameraShareBtn">Share Camera</button>
      <button id="hangupBtn" disabled>Hang up</button>
    </div>

    <div>
      <label>Join as Viewer</label>
      <input id="roomIdInput" placeholder="Paste room ID" />
      <button id="joinBtn">Join room</button>
    </div>
  </div>

  <div class="info">
    <div><strong>Room ID:</strong> <span id="roomIdDisplay">—</span></div>
    <div style="margin-top:8px;">
      <label>Local (Host)</label>
      <video id="localVideo" autoplay playsinline muted></video>
    </div>
    <div style="margin-top:12px;">
      <label>Remote (Viewer)</label>
      <video id="remoteVideo" autoplay playsinline></video>
    </div>
  </div>

  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

  <script>
  // ---------- FIREBASE CONFIG ----------
  const firebaseConfig = {
    apiKey: "AIzaSyD0T-mS__FlN3QASJnmD0K6S5VNDiN2bxQ",
    authDomain: "poplol-7209f.firebaseapp.com",
    projectId: "poplol-7209f",
    storageBucket: "poplol-7209f.appspot.com",
    messagingSenderId: "105810834",
    appId: "1:105810834:web:example"
  };

  firebase.initializeApp(firebaseConfig);
  const firestore = firebase.firestore();

  // ---------- UI ----------
  const screenShareBtn = document.getElementById('screenShareBtn');
  const cameraShareBtn = document.getElementById('cameraShareBtn');
  const joinBtn = document.getElementById('joinBtn');
  const hangupBtn = document.getElementById('hangupBtn');
  const roomIdInput = document.getElementById('roomIdInput');
  const roomIdDisplay = document.getElementById('roomIdDisplay');
  const localVideo = document.getElementById('localVideo');
  const remoteVideo = document.getElementById('remoteVideo');

  // ---------- WebRTC ----------
  const configuration = { iceServers: [{ urls: 'stun:stun.l.google.com:19302' }] };
  let pc = null;
  let localStream = null;
  let roomRef = null;
  let localCandidatesCollection = null;
  let remoteCandidatesCollection = null;

  // ---------- Helper: start stream ----------
  async function startStream(type) {
    try {
      if (type === 'screen') {
        if (navigator.mediaDevices.getDisplayMedia) {
          localStream = await navigator.mediaDevices.getDisplayMedia({ video: true, audio: true });
        } else {
          alert("Screen share not supported. Falling back to camera.");
          localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
        }
      } else {
        localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
      }

      localVideo.srcObject = localStream;
      return localStream;
    } catch (err) {
      alert("Could not start stream: " + err.message);
      throw err;
    }
  }

  // ---------- Create room (host) ----------
  async function createRoom(type) {
    screenShareBtn.disabled = true;
    cameraShareBtn.disabled = true;

    try {
      localStream = await startStream(type);

      pc = new RTCPeerConnection(configuration);
      pc.onicecandidate = e => {
        if (e.candidate && localCandidatesCollection) {
          localCandidatesCollection.add(e.candidate.toJSON());
        }
      };
      pc.ontrack = e => { remoteVideo.srcObject = e.streams[0]; };

      localStream.getTracks().forEach(track => pc.addTrack(track, localStream));

      roomRef = await firestore.collection('rooms').doc();
      localCandidatesCollection = roomRef.collection('callerCandidates');

      const offer = await pc.createOffer();
      await pc.setLocalDescription(offer);

      await roomRef.set({ offer: { type: offer.type, sdp: offer.sdp } });
      roomIdDisplay.textContent = roomRef.id;
      roomIdInput.value = roomRef.id;

      roomRef.onSnapshot(snapshot => {
        const data = snapshot.data();
        if (data && data.answer && !pc.currentRemoteDescription) {
          pc.setRemoteDescription(new RTCSessionDescription(data.answer));
        }
      });

      remoteCandidatesCollection = roomRef.collection('calleeCandidates');
      remoteCandidatesCollection.onSnapshot(snapshot => {
        snapshot.docChanges().forEach(async change => {
          if (change.type === 'added') {
            await pc.addIceCandidate(new RTCIceCandidate(change.doc.data()));
          }
        });
      });

      hangupBtn.disabled = false;
    } catch (err) {
      console.error("Create room error:", err);
      screenShareBtn.disabled = false;
      cameraShareBtn.disabled = false;
    }
  }

  // ---------- Join room (viewer) ----------
  joinBtn.onclick = async () => {
    const roomId = roomIdInput.value.trim();
    if (!roomId) return alert("Enter a room ID");

    joinBtn.disabled = true;
    roomRef = firestore.collection('rooms').doc(roomId);
    const roomSnapshot = await roomRef.get();
    if (!roomSnapshot.exists) return alert("Room not found");

    pc = new RTCPeerConnection(configuration);
    pc.onicecandidate = e => {
      if (e.candidate) roomRef.collection('calleeCandidates').add(e.candidate.toJSON());
    };
    pc.ontrack = e => { remoteVideo.srcObject = e.streams[0]; };

    const offer = roomSnapshot.data().offer;
    await pc.setRemoteDescription(new RTCSessionDescription(offer));

    const answer = await pc.createAnswer();
    await pc.setLocalDescription(answer);
    await roomRef.update({ answer: { type: answer.type, sdp: answer.sdp } });

    roomRef.collection('callerCandidates').onSnapshot(snapshot => {
      snapshot.docChanges().forEach(change => {
        if (change.type === 'added') pc.addIceCandidate(new RTCIceCandidate(change.doc.data()));
      });
    });

    roomIdDisplay.textContent = roomRef.id;
    hangupBtn.disabled = false;
  };

  // ---------- Hang up ----------
  hangupBtn.onclick = async () => {
    if (localStream) localStream.getTracks().forEach(t => t.stop());
    if (pc) pc.close();

    if (roomRef) {
      const deleteCollection = async col => {
        const snap = await col.get();
        const batch = firestore.batch();
        snap.docs.forEach(doc => batch.delete(doc.ref));
        await batch.commit();
      };
      try {
        await deleteCollection(roomRef.collection('callerCandidates'));
        await deleteCollection(roomRef.collection('calleeCandidates'));
        await roomRef.delete();
      } catch (e) { console.warn("Cleanup error:", e); }
    }

    roomRef = null;
    localVideo.srcObject = null;
    remoteVideo.srcObject = null;
    roomIdDisplay.textContent = "—";
    roomIdInput.value = "";

    screenShareBtn.disabled = false;
    cameraShareBtn.disabled = false;
    joinBtn.disabled = false;
    hangupBtn.disabled = true;
  };

  // ---------- Bind buttons ----------
  screenShareBtn.onclick = () => createRoom('screen');
  cameraShareBtn.onclick = () => createRoom('camera');

  window.addEventListener('beforeunload', () => {
    if (localStream) localStream.getTracks().forEach(t => t.stop());
    if (pc) pc.close();
  });
  </script>
</body>
</html>
