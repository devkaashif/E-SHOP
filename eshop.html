<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Simple Screen Sharing (Firestore signaling)</title>
  <style>
    body { font-family: system-ui, Arial; max-width:900px; margin:32px auto; }
    h1 { margin-bottom: 6px; }
    .row { display:flex; gap:12px; margin:12px 0; flex-wrap:wrap; }
    button { padding:8px 12px; }
    input { padding:8px; min-width:220px; }
    video { width:100%; max-height: 60vh; background:#000; border-radius:6px; }
    .small { font-size: 0.9rem; color:#555; }
    .info { margin-top:18px; padding:12px; border-radius:8px; background:#f6f6f6; color:#333; }
    label { display:block; margin-bottom:6px; font-weight:600;}
  </style>
</head>
<body>
  <h1>Screen sharing demo (Firestore signaling)</h1>
  <p class="small">Create a room to start sharing your screen. Copy the Room ID and share it with a viewer to join.</p>

  <div class="row">
    <div>
      <label>Create room (host / share screen)</label>
      <button id="createBtn">Create room & share</button>
      <button id="hangupBtn" disabled>Hang up</button>
    </div>

    <div>
      <label>Join room (viewer)</label>
      <input id="roomIdInput" placeholder="Paste room ID here" />
      <button id="joinBtn">Join room</button>
    </div>
  </div>

  <div class="info">
    <div><strong>Room ID:</strong> <span id="roomIdDisplay">—</span></div>
    <div style="margin-top:8px;">
      <label>Local preview (host only)</label>
      <video id="localVideo" autoplay playsinline muted></video>
    </div>
    <div style="margin-top:12px;">
      <label>Remote / viewer video</label>
      <video id="remoteVideo" autoplay playsinline></video>
    </div>
  </div>

  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

  <script>
  // ---------- FIREBASE CONFIG ----------
  const firebaseConfig = {
    apiKey: "AIzaSyD0T-mS__FlN3QASJnmD0K6S5VNDiN2bxQ",
    authDomain: "poplol-7209f.firebaseapp.com",
    projectId: "poplol-7209f",
    storageBucket: "poplol-7209f.appspot.com",
    messagingSenderId: "105810834",
    appId: "1:105810834:web:example"
  };

  // Initialize Firebase
  firebase.initializeApp(firebaseConfig);
  const firestore = firebase.firestore();

  // ---------- UI elements ----------
  const createBtn = document.getElementById('createBtn');
  const joinBtn = document.getElementById('joinBtn');
  const hangupBtn = document.getElementById('hangupBtn');
  const roomIdInput = document.getElementById('roomIdInput');
  const roomIdDisplay = document.getElementById('roomIdDisplay');
  const localVideo = document.getElementById('localVideo');
  const remoteVideo = document.getElementById('remoteVideo');

  // ---------- WebRTC variables ----------
  const configuration = {
    iceServers: [
      { urls: 'stun:stun.l.google.com:19302' }
    ]
  };

  let pc = null;
  let localStream = null;
  let roomRef = null;
  let localCandidatesCollection = null;
  let remoteCandidatesCollection = null;

  // ---------- Create room (host) ----------
  createBtn.onclick = async () => {
    createBtn.disabled = true;
    try {
      // 1. get screen stream from user
      localStream = await navigator.mediaDevices.getDisplayMedia({ video: true, audio: true });
      localVideo.srcObject = localStream;

      // 2. create RTCPeerConnection
      pc = new RTCPeerConnection(configuration);

      // send local ICE candidates to Firestore subcollection 'callerCandidates'
      localCandidatesCollection = null; // set later after room created
      pc.onicecandidate = event => {
        if (!event.candidate) return;
        if (!localCandidatesCollection) return;
        localCandidatesCollection.add(event.candidate.toJSON());
      };

      // Show remote track on remoteVideo (viewer side)
      pc.ontrack = event => {
        // remote stream may contain multiple tracks; attach first stream
        remoteVideo.srcObject = event.streams[0];
      };

      // add local tracks (screen)
      localStream.getTracks().forEach(track => pc.addTrack(track, localStream));

      // 3. create room document in Firestore
      roomRef = await firestore.collection('rooms').doc(); // auto id
      localCandidatesCollection = roomRef.collection('callerCandidates');

      // 4. create offer
      const offer = await pc.createOffer();
      await pc.setLocalDescription(offer);

      const roomWithOffer = {
        offer: {
          type: offer.type,
          sdp: offer.sdp
        },
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
      };
      await roomRef.set(roomWithOffer);

      // display room id
      roomIdDisplay.textContent = roomRef.id;
      roomIdInput.value = roomRef.id;

      // 5. listen for answer
      roomRef.onSnapshot(async snapshot => {
        const data = snapshot.data();
        if (!pc.currentRemoteDescription && data && data.answer) {
          const answer = new RTCSessionDescription(data.answer);
          await pc.setRemoteDescription(answer);
        }
      });

      // 6. listen for remote ICE candidates from 'calleeCandidates'
      remoteCandidatesCollection = roomRef.collection('calleeCandidates');
      remoteCandidatesCollection.onSnapshot(snapshot => {
        snapshot.docChanges().forEach(async change => {
          if (change.type === 'added') {
            const candidate = new RTCIceCandidate(change.doc.data());
            await pc.addIceCandidate(candidate);
          }
        });
      });

      // allow viewer to hang up
      hangupBtn.disabled = false;
    } catch (err) {
      console.error('Create room failed:', err);
      alert('Failed to create room: ' + (err.message || err));
      createBtn.disabled = false;
    }
  };

  // ---------- Join room (viewer) ----------
  joinBtn.onclick = async () => {
    const roomId = roomIdInput.value.trim();
    if (!roomId) { alert('Enter a room ID'); return; }
    joinBtn.disabled = true;

    try {
      roomRef = firestore.collection('rooms').doc(roomId);
      const roomSnapshot = await roomRef.get();
      if (!roomSnapshot.exists) {
        alert('Room does not exist.');
        joinBtn.disabled = false;
        return;
      }

      // create peer connection for viewer (callee)
      pc = new RTCPeerConnection(configuration);

      // viewer won't capture local display by default; but if you want viewer audio output only, no local tracks added.
      // If you want viewer to send audio/video back, capture and add tracks here.

      // send local ICE candidates to 'calleeCandidates'
      const calleeCandidatesCollection = roomRef.collection('calleeCandidates');
      pc.onicecandidate = event => {
        if (!event.candidate) return;
        calleeCandidatesCollection.add(event.candidate.toJSON());
      };

      // show remote stream when tracks arrive
      pc.ontrack = event => {
        remoteVideo.srcObject = event.streams[0];
      };

      // get offer
      const roomData = roomSnapshot.data();
      const offer = roomData.offer;
      await pc.setRemoteDescription(new RTCSessionDescription(offer));

      // create answer
      const answer = await pc.createAnswer();
      await pc.setLocalDescription(answer);

      // update room with answer
      const answerData = {
        answer: {
          type: answer.type,
          sdp: answer.sdp
        },
        answeredAt: firebase.firestore.FieldValue.serverTimestamp()
      };
      await roomRef.update(answerData);

      // listen for caller ICE candidates
      const callerCandidatesCollection = roomRef.collection('callerCandidates');
      callerCandidatesCollection.onSnapshot(snapshot => {
        snapshot.docChanges().forEach(async change => {
          if (change.type === 'added') {
            const data = change.doc.data();
            await pc.addIceCandidate(new RTCIceCandidate(data));
          }
        });
      });

      // update UI
      roomIdDisplay.textContent = roomRef.id;
      hangupBtn.disabled = false;
    } catch (err) {
      console.error('Join failed:', err);
      alert('Failed to join: ' + (err.message || err));
      joinBtn.disabled = false;
    }
  };

  // ---------- Hang up / cleanup ----------
  hangupBtn.onclick = async () => {
    try {
      // stop local tracks
      if (localStream) {
        localStream.getTracks().forEach(t => t.stop());
        localStream = null;
        localVideo.srcObject = null;
      }

      // close RTCPeerConnection
      if (pc) {
        pc.close();
        pc = null;
      }

      // optionally delete room and its subcollections (callerCandidates / calleeCandidates)
      if (roomRef) {
        // delete subcollections (callerCandidates and calleeCandidates)
        const deleteCollection = async colRef => {
          const snap = await colRef.get();
          const batch = firestore.batch();
          snap.docs.forEach(doc => batch.delete(doc.ref));
          await batch.commit();
        };

        try {
          await deleteCollection(roomRef.collection('callerCandidates'));
          await deleteCollection(roomRef.collection('calleeCandidates'));
          await roomRef.delete();
        } catch (err) {
          console.warn('Cleanup warning (non-fatal):', err);
        }
      }

      roomRef = null;
      roomIdDisplay.textContent = '—';
      roomIdInput.value = '';
      hangupBtn.disabled = true;
      createBtn.disabled = false;
      joinBtn.disabled = false;
      remoteVideo.srcObject = null;
    } catch (err) {
      console.error('Hangup error:', err);
    }
  };

  // Safety: warn before unload
  window.addEventListener('beforeunload', () => {
    if (localStream) localStream.getTracks().forEach(t => t.stop());
    if (pc) pc.close();
  });
  </script>
</body>
</html>
